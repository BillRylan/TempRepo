import warnings
from urllib3.exceptions import InsecureRequestWarning
from flask import Flask, request
from flask_restx import Api, Resource, fields
from jira import JIRA, exceptions
from config import Config

app = Flask(__name__)
app.config.from.config.from_object(Config)
warnings.filterwarnings("ignore", category=InsecureRequestWarning)

# Initialize Jira connection
try:
    jira = JIRA(
        server=Config.JIRA_SERVER,
        basic_auth=(Config.JIRA_EMAIL, Config.JIRA_API_TOKEN),
        verify_ssl=False
    )
except exceptions.JIRAError as e:
    app.logger.error(f"Jira connection failed: {str(e)}")
    jira = None

# Initialize Swagger documentation
api = Api(
    app,
    version='1.8',
    title='Jira API Proxy',
    description='Jira API proxy service with separated endpoint classes',
    doc='/docs/'
)

# -------------------------- API Models --------------------------
issue_model = api.model('Issue', {
    'project': fields.String(required=True, description='Project key (e.g., "PROJ")'),
    'issuetype': fields.String(required=True, description='Issue type (e.g., "Task", "Bug")'),
    'summary': fields.String(required=True, description='Issue title (max 255 characters)'),
    'description': fields.String(description='Detailed description (markdown supported)'),
    'priority': fields.String(description='Priority level (e.g., "High", "Medium")'),
    'assignee': fields.String(description='Assignee username (e.g., "john.doe")'),
    'reporter': fields.String(description='Reporter username (default: current user)'),
    'labels': fields.List(fields.String, description='List of labels (e.g., ["frontend", "bug"])'),
    'components': fields.List(fields.String, description='List of components (e.g., ["UI", "Backend"])'),
    'versions': fields.List(fields.String, description='List of fix versions (e.g., ["v1.0"])'),
    'due_date': fields.String(description='Due date in ISO format (e.g., "2024-12-31")'),
    'custom_fields': fields.Raw(description='Custom fields ({"customfield_10000": "value"})')
})

transition_model = api.model('Transition', {
    'transition': fields.String(required=True, description='Transition name (e.g., "In Progress")'),
    'comment': fields.String(description='Transition comment (markdown supported)'),
    'assignee': fields.String(description='Update assignee (username or "none")'),
    'resolution': fields.String(description='Resolution (e.g., "Fixed" for completion transitions)'),
    'custom_fields': fields.Raw(description='Update custom fields during transition')
})

subtask_model = api.model('SubTask', {
    'summary': fields.String(required=True, description='Subtask title'),
    'description': fields.String(description='Subtask details'),
    'priority': fields.String(description='Priority level (e.g., "Medium")'),
    'assignee': fields.String(description='Assignee username'),
    'labels': fields.List(fields.String, description='List of labels (e.g., ["subtask"])'),
    'due_date': fields.String(description='Due date in ISO format (e.g., "2024-11-30")')
})

# -------------------------- Namespaces --------------------------
ns_issue = api.namespace('issues', description='Issue management endpoints')
ns_project = api.namespace('projects', description='Project management endpoints')
ns_user = api.namespace('users', description='User management endpoints')


# Error handling decorator
def handle_jira_errors(func):
    def wrapper(*args, **kwargs):
        if not jira:
            return {'error': 'Jira service connection failed'}, 500
        try:
            return func(*args, **kwargs)
        except exceptions.JIRAError as e:
            return {'error': str(e)}, e.status_code
        except Exception as e:
            return {'error': f'Server error: {str(e)}'}, 500
    return wrapper


# -------------------------- Issue Endpoints --------------------------
@ns_issue.route('/search')
@api.doc(description='Search issues using JQL queries')
class IssueSearch(Resource):
    @handle_jira_errors
    @api.doc(
        params={
            'jql': 'JQL query to filter issues (e.g., "project=PROJ AND status=\'Open\'"; default: "project is not empty")',
            'maxResults': 'Maximum number of results to return (default: 20; max: 1000)',
            'startAt': 'Pagination offset (default: 0)',
            'fields': 'Comma-separated fields to return (e.g., "summary,status,assignee"; default: "id,key,summary,status,assignee")'
        },
        responses={
            200: 'Successfully retrieved issues',
            400: 'Invalid JQL query format',
            500: 'Server or Jira connection error'
        }
    )
    def get(self):
        """Search and retrieve issues"""
        jql = request.args.get('jql', 'project is not empty')
        max_results = int(request.args.get('maxResults', 20))
        start_at = int(request.args.get('startAt', 0))
        fields = request.args.get('fields', 'id,key,summary,status,assignee')
        
        issues = jira.search_issues(
            jql,
            maxResults=max_results,
            startAt=start_at,
            fields=fields
        )
        
        result = []
        for issue in issues:
            issue_data = {'id': issue.id, 'key': issue.key}
            for field in fields.split(','):
                if hasattr(issue.fields, field):
                    field_value = getattr(issue.fields, field)
                    if field == 'assignee' and field_value:
                        issue_data[field] = {
                            'username': field_value.name,
                            'display_name': field_value.displayName
                        }
                    elif field == 'status' and field_value:
                        issue_data[field] = field_value.name
                    else:
                        issue_data[field] = str(field_value) if field_value else None
            result.append(issue_data)
        
        return {
            'total_issues': issues.total,
            'start_at': start_at,
            'max_results': max_results,
            'issues': result
        }


@ns_issue.route('/create')
@api.doc(description='Create a new issue in Jira')
class IssueCreate(Resource):
    @handle_jira_errors
    @api.doc(
        params={
            'project': 'Required. Project key (e.g., "PROJ")',
            'issuetype': 'Required. Issue type (e.g., "Task", "Bug", "Epic")',
            'summary': 'Required. Issue title (max 255 characters)',
            'description': 'Optional. Detailed description (markdown supported)',
            'priority': 'Optional. Priority level (e.g., "Highest", "High", "Medium"; default: "Medium")',
            'assignee': 'Optional. Assignee username or ID (e.g., "john.doe")',
            'reporter': 'Optional. Reporter username (default: current Jira user)',
            'labels': 'Optional. List of labels (e.g., ["frontend", "bugfix"])',
            'components': 'Optional. List of component names (e.g., ["UI", "Backend"])',
            'versions': 'Optional. List of fix version names (e.g., ["v1.0", "v2.1"])',
            'due_date': 'Optional. Due date in ISO 8601 format (e.g., "2024-12-31")',
            'custom_fields': 'Optional. Custom fields in JSON format ({"customfield_10000": "value"})'
        },
        responses={
            201: 'Issue created successfully',
            400: 'Missing required fields or invalid parameters',
            500: 'Server or Jira connection error'
        }
    )
    @api.expect(issue_model)
    def post(self):
        """Create a new issue"""
        data = api.payload
        issue_fields = {
            'project': {'key': data['project']},
            'issuetype': {'name': data['issuetype']},
            'summary': data['summary'],
            'description': data.get('description', ''),
        }

        if 'priority' in data:
            issue_fields['priority'] = {'name': data['priority']}
        if 'assignee' in data:
            issue_fields['assignee'] = {'name': data['assignee']}
        if 'reporter' in data:
            issue_fields['reporter'] = {'name': data['reporter']}
        if 'labels' in data:
            issue_fields['labels'] = data['labels']
        if 'components' in data:
            issue_fields['components'] = [{'name': c} for c in data['components']]
        if 'versions' in data:
            issue_fields['versions'] = [{'name': v} for v in data['versions']]
        if 'due_date' in data:
            issue_fields['duedate'] = data['due_date']
        if 'custom_fields' in data:
            issue_fields.update(data['custom_fields'])

        issue = jira.create_issue(fields=issue_fields)
        return {
            'id': issue.id,
            'key': issue.key,
            'summary': issue.fields.summary,
            'status': issue.fields.status.name,
            'assignee': issue.fields.assignee.displayName if issue.fields.assignee else None,
            'created_at': issue.fields.created,
            'url': issue.permalink()
        }, 201


@ns_issue.route('/<string:issue_key>/detail')
@api.doc(
    description='Get detailed information about a specific issue',
    params={'issue_key': 'Unique issue identifier (e.g., "PROJ-123")'}
)
class IssueDetail(Resource):
    @handle_jira_errors
    def get(self, issue_key):
        """Get issue details"""
        issue = jira.issue(issue_key)
        return {
            'id': issue.id,
            'key': issue.key,
            'summary': issue.fields.summary,
            'description': issue.fields.description,
            'status': issue.fields.status.name,
            'priority': issue.fields.priority.name,
            'assignee': {
                'username': issue.fields.assignee.name,
                'display_name': issue.fields.assignee.displayName
            } if issue.fields.assignee else None,
            'created': issue.fields.created,
            'updated': issue.fields.updated,
            'url': issue.permalink()
        }


@ns_issue.route('/<string:issue_key>/status')
@api.doc(
    description='Get current status of a specific issue',
    params={'issue_key': 'Unique issue identifier (e.g., "PROJ-123")'}
)
class IssueStatus(Resource):
    @handle_jira_errors
    def get(self, issue_key):
        """Get current issue status"""
        issue = jira.issue(issue_key, fields='status,updated')
        return {
            'issue_key': issue_key,
            'current_status': issue.fields.status.name,
            'status_id': issue.fields.status.id,
            'last_updated': issue.fields.updated
        }


@ns_issue.route('/<string:issue_key>/transitions/list')
@api.doc(
    description='Get all available status transitions for an issue',
    params={'issue_key': 'Unique issue identifier (e.g., "PROJ-123")'}
)
class IssueTransitionsList(Resource):
    @handle_jira_errors
    def get(self, issue_key):
        """Get available transitions"""
        transitions = jira.transitions(issue_key)
        return [{
            'id': t['id'],
            'name': t['name'],
            'from_status': t['from']['name'] if 'from' in t else None,
            'to_status': t['to']['name']
        } for t in transitions]


@ns_issue.route('/<string:issue_key>/transitions/execute')
@api.doc(
    description='Execute a status transition for an issue',
    params={
        'issue_key': 'Unique issue identifier (e.g., "PROJ-123")',
        'transition': 'Required. Transition name (e.g., "In Progress", "Done")',
        'comment': 'Optional. Transition comment (markdown supported)',
        'assignee': 'Optional. Update assignee during transition (username or "none")',
        'resolution': 'Optional. Resolution name (e.g., "Fixed" for completion)',
        'custom_fields': 'Optional. Custom fields to update (JSON format)'
    }
)
class IssueTransitionsExecute(Resource):
    @handle_jira_errors
    @api.expect(transition_model)
    def post(self, issue_key):
        """Execute a status transition"""
        data = api.payload
        transition_name = data['transition']
        transition_args = {}

        if 'comment' in data:
            transition_args['comment'] = data['comment']
        if 'assignee' in data:
            transition_args['assignee'] = {'name': data['assignee']}
        if 'resolution' in data:
            transition_args['resolution'] = {'name': data['resolution']}
        if 'custom_fields' in data:
            transition_args.update(data['custom_fields'])

        transitions = jira.transitions(issue_key)
        transition = next(
            (t for t in transitions if t['name'].lower() == transition_name.lower()),
            None
        )
        if not transition:
            return {'error': f'Transition "{transition_name}" not found'}, 400

        jira.transition_issue(issue_key, transition['id'],** transition_args)
        updated_issue = jira.issue(issue_key, fields='status,assignee,updated')

        return {
            'issue_key': issue_key,
            'transition_executed': transition_name,
            'current_status': updated_issue.fields.status.name,
            'current_assignee': updated_issue.fields.assignee.displayName if updated_issue.fields.assignee else None,
            'updated_at': updated_issue.fields.updated,
            'comment': data.get('comment')
        }


@ns_issue.route('/<string:issue_key>/subtasks/list')
@api.doc(
    description='Get all subtasks associated with a parent issue',
    params={'issue_key': 'Parent issue identifier (e.g., "PROJ-123")'}
)
class IssueSubtasksList(Resource):
    @handle_jira_errors
    def get(self, issue_key):
        """Get subtasks list"""
        issue = jira.issue(issue_key, fields='subtasks')
        return [{
            'id': subtask.id,
            'key': subtask.key,
            'summary': subtask.fields.summary,
            'status': subtask.fields.status.name,
            'created': subtask.fields.created
        } for subtask in issue.fields.subtasks]


@ns_issue.route('/<string:issue_key>/subtasks/create')
@api.doc(
    description='Create a new subtask linked to a parent issue',
    params={
        'issue_key': 'Parent issue identifier (e.g., "PROJ-123")',
        'summary': 'Required. Subtask title',
        'description': 'Optional. Subtask details',
        'priority': 'Optional. Priority level (e.g., "Medium"; default: "Medium")',
        'assignee': 'Optional. Assignee username (e.g., "jane.smith")',
        'labels': 'Optional. List of labels (e.g., ["subtask", "urgent"])',
        'due_date': 'Optional. Due date in ISO format (e.g., "2024-11-30")'
    }
)
class IssueSubtasksCreate(Resource):
    @handle_jira_errors
    @api.expect(subtask_model)
    def post(self, issue_key):
        """Create a subtask"""
        data = api.payload
        main_issue = jira.issue(issue_key, fields='project')
        project_key = main_issue.fields.project.key

        subtask_fields = {
            'project': {'key': project_key},
            'issuetype': {'name': 'Sub-task'},
            'summary': data['summary'],
            'description': data.get('description', ''),
            'parent': {'key': issue_key}
        }

        if 'priority' in data:
            subtask_fields['priority'] = {'name': data['priority']}
        if 'assignee' in data:
            subtask_fields['assignee'] = {'name': data['assignee']}
        if 'labels' in data:
            subtask_fields['labels'] = data['labels']
        if 'due_date' in data:
            subtask_fields['duedate'] = data['due_date']

        subtask = jira.create_issue(fields=subtask_fields)
        return {
            'subtask_key': subtask.key,
            'subtask_id': subtask.id,
            'parent_key': issue_key,
            'summary': subtask.fields.summary,
            'status': subtask.fields.status.name,
            'assignee': subtask.fields.assignee.displayName if subtask.fields.assignee else None,
            'created_at': subtask.fields.created,
            'url': subtask.permalink()
        }, 201


@ns_issue.route('/<string:issue_key>/changelog')
@api.doc(
    description='Get complete change history of an issue',
    params={'issue_key': 'Unique issue identifier (e.g., "PROJ-123")'}
)
class IssueChangelog(Resource):
    @handle_jira_errors
    def get(self, issue_key):
        """Get issue change history"""
        issue = jira.issue(issue_key)
        changelog = []
        for history in issue.changelog.histories:
            changelog.append({
                'author': history.author.displayName,
                'timestamp': history.created,
                'changes': [{
                    'field': item.field,
                    'from_value': item.fromString,
                    'to_value': item.toString
                } for item in history.items]
            })
        return changelog


# -------------------------- Project Endpoints --------------------------
@ns_project.route('/list')
@api.doc(description='Get list of all projects in Jira instance')
class ProjectList(Resource):
    @handle_jira_errors
    def get(self):
        """Get all projects"""
        projects = jira.projects()
        return [{
            'id': p.id,
            'key': p.key,
            'name': p.name,
            'description': p.description,
            'lead': p.lead.displayName if p.lead else None
        } for p in projects]


@ns_project.route('/<string:project_key>/detail')
@api.doc(
    description='Get detailed information about a specific project',
    params={'project_key': 'Project identifier (e.g., "PROJ")'}
)
class ProjectDetail(Resource):
    @handle_jira_errors
    def get(self, project_key):
        """Get project details"""
        project = jira.project(project_key)
        return {
            'id': project.id,
            'key': project.key,
            'name': project.name,
            'description': project.description,
            'lead': {
                'username': project.lead.name,
                'display_name': project.lead.displayName
            } if project.lead else None,
            'components': [c.name for c in jira.project_components(project_key)],
            'versions': [v.name for v in jira.project_versions(project_key)],
            'created_at': project.createdAt
        }


# -------------------------- User Endpoints --------------------------
@ns_user.route('/search')
@api.doc(
    description='Search users by username, email, or display name',
    params={'query': 'Search term (e.g., "john", "john@example.com"; default: empty string)'}
)
class UserSearch(Resource):
    @handle_jira_errors
    def get(self):
        """Search users"""
        query = request.args.get('query', '')
        users = jira.search_users(query)
        return [{
            'username': u.name,
            'display_name': u.displayName,
            'email': u.emailAddress,
            'active': u.active,
            'account_id': u.accountId
        } for u in users]


if __name__ == '__main__':
    app.run(host='0.0.0.0', port=Config.PORT)
