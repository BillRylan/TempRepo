下面是修改后的登录部分代码，使用 `python-jira` 库替代原生 requests 进行用户名密码登录验证。需要先安装依赖：`pip install jira`

```python
# app.py (修改部分)
from jira import JIRA
from jira.exceptions import JIRAError  # 用于捕获Jira相关错误

# 移除原有的JIRA_BASE_URL全局变量定义

@app.route('/login', methods=['POST'])
def login():
    """处理 Jira 登录请求（使用python-jira库）"""
    username = request.form.get('username')
    password = request.form.get('password')  # 改为password参数
    jira_url = request.form.get('jira_url')
    
    # 验证输入
    if not all([username, password, jira_url]):
        return render_template('login.html', error="All fields are required")
    
    # 尝试使用python-jira库连接Jira
    try:
        # 配置Jira连接
        jira_options = {
            'server': jira_url.rstrip('/'),
            'verify': True  # 验证SSL证书，生产环境建议保持True
        }
        
        # 使用用户名密码登录
        jira = JIRA(options=jira_options, basic_auth=(username, password))
        
        # 登录成功 - 获取用户信息验证连接
        user_info = jira.myself()
        
        # 保存关键信息到会话
        session['jira_auth'] = (username, password)
        session['jira_url'] = jira_url.rstrip('/')
        session['user_info'] = user_info
        
        return redirect(url_for('index'))
    
    except JIRAError as e:
        # 处理Jira相关错误
        if e.status_code == 401:
            return render_template('login.html', error="Invalid username or password")
        elif e.status_code == 403:
            return render_template('login.html', error="Permission denied - check your access")
        elif e.status_code == 404:
            return render_template('login.html', error="Jira URL not found - check the URL")
        else:
            return render_template('login.html', error=f"Jira error: {str(e)}")
    except Exception as e:
        # 处理其他连接错误
        return render_template('login.html', error=f"Connection error: {str(e)}")
```

同时需要修改登录模板 `login.html` 中对应的字段名（将 `api_token` 改为 `password`）：

```html
<!-- templates/login.html (修改部分) -->
<div class="mb-6">
    <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
    <div class="relative">
        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <i class="fa fa-lock text-gray-400"></i>
        </div>
        <input type="password" name="password" id="password" 
               class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary"
               placeholder="your-jira-password" required>
    </div>
</div>
```

此外，需要修改其他依赖 Jira 连接的函数，统一使用 `python-jira` 库的实例。例如在 `create_issue` 函数中：

```python
# 在需要使用Jira的函数中统一创建JIRA实例
def get_jira_instance():
    """从会话信息创建JIRA实例"""
    if 'jira_auth' not in session or 'jira_url' not in session:
        return None
    username, password = session['jira_auth']
    return JIRA(
        options={'server': session['jira_url']},
        basic_auth=(username, password)
    )

@app.route('/create-issue', methods=['GET', 'POST'])
def create_issue():
    """创建 Jira Issue 功能（使用python-jira库）"""
    jira = get_jira_instance()
    if not jira:
        return redirect(url_for('index'))
    
    # 获取项目列表
    projects = []
    try:
        projects = sorted(jira.projects(), key=lambda x: x.name)
    except JIRAError as e:
        return render_template('create_issue.html', projects=[], error=f"Error fetching projects: {str(e)}")
    
    if request.method == 'POST':
        # 处理创建issue请求
        try:
            issue_dict = {
                'project': {'id': request.form.get('project_id')},
                'summary': request.form.get('summary'),
                'description': request.form.get('description'),
                'issuetype': {'name': request.form.get('issue_type')},
            }
            issue = jira.create_issue(fields=issue_dict)
            return redirect(url_for('issue_detail', issue_key=issue.key))
        except JIRAError as e:
            return render_template('create_issue.html', 
                                  projects=projects, 
                                  error=f"Error creating issue: {str(e)}")
    
    return render_template('create_issue.html', projects=projects)
```

修改说明：
1. 使用 `python-jira` 库的 `JIRA` 类进行登录验证，更符合官方推荐的操作方式
2. 登录参数从 `api_token` 改为 `password`，适应密码登录场景
3. 增加了更细致的错误处理，通过 `JIRAError` 捕获不同类型的Jira错误
4. 新增 `get_jira_instance()` 函数统一管理Jira连接实例，避免代码重复
5. 后续的Jira操作（创建issue、获取详情等）也统一使用 `python-jira` 库的API，保持一致性

注意：使用密码登录需要确保你的Jira服务器允许基本认证（Basic Auth），部分新版本Jira可能默认禁用密码登录，此时可能需要在Jira管理员控制台开启相关权限。
