from flask import Flask, render_template, jsonify, request, session
from transitions import Machine
from jira import JIRA
from jira.exceptions import JIRAError
import os

app = Flask(__name__)
app.secret_key = os.urandom(24)  # 用于会话管理的密钥

# Jira工作流状态机定义（与之前相同）
class ArchitectureWorkflow:
    def __init__(self):
        self.states = [
            'OPEN', 'POC', 'SURGERY', 'IN_DEV', 
            'TDA', 'TECH_FORUM', 'UAT', 'PROD', 'DONE'
        ]
        
        self.transitions = [
            {'trigger': 'to_poc', 'source': 'OPEN', 'dest': 'POC'},
            {'trigger': 'to_surgery', 'source': 'POC', 'dest': 'SURGERY'},
            {'trigger': 'poc_retry', 'source': 'POC', 'dest': 'POC'},
            {'trigger': 'to_in_dev', 'source': 'SURGERY', 'dest': 'IN_DEV'},
            {'trigger': 'surgery_to_poc', 'source': 'SURGERY', 'dest': 'POC'},
            {'trigger': 'to_tda', 'source': 'IN_DEV', 'dest': 'TDA'},
            {'trigger': 'dev_retry', 'source': 'IN_DEV', 'dest': 'IN_DEV'},
            {'trigger': 'to_tech_forum', 'source': 'TDA', 'dest': 'TECH_FORUM'},
            {'trigger': 'tda_to_dev', 'source': 'TDA', 'dest': 'IN_DEV'},
            {'trigger': 'to_uat', 'source': 'TECH_FORUM', 'dest': 'UAT'},
            {'trigger': 'tech_to_tda', 'source': 'TECH_FORUM', 'dest': 'TDA'},
            {'trigger': 'to_prod', 'source': 'UAT', 'dest': 'PROD'},
            {'trigger': 'uat_to_tech', 'source': 'UAT', 'dest': 'TECH_FORUM'},
            {'trigger': 'to_done', 'source': 'PROD', 'dest': 'DONE'},
            {'trigger': 'prod_to_uat', 'source': 'PROD', 'dest': 'UAT'},
            {'trigger': 'force_done', 'source': '*', 'dest': 'DONE'}
        ]
        
        self.machine = Machine(
            model=self,
            states=self.states,
            transitions=self.transitions,
            initial='OPEN'
        )

# 全局工作流实例和Jira连接
workflow = ArchitectureWorkflow()
jira = None  # Jira连接实例将在登录后初始化

# 状态和过渡的描述映射
state_descriptions = {
    'OPEN': 'Initial state: Architecture decision proposal created',
    'POC': 'Proof of Concept: Validating technical feasibility',
    'SURGERY': 'Solution Design: Developing detailed implementation plan',
    'IN_DEV': 'In Development: Implementation according to plan',
    'TDA': 'Technical Decision Review: Internal technical assessment',
    'TECH_FORUM': 'Technical Forum Review: Cross-team technical evaluation',
    'UAT': 'User Acceptance Testing: Verifying requirements fulfillment',
    'PROD': 'Production Deployment: Live in production environment',
    'DONE': 'Completed: Workflow finalized'
}

transition_labels = {
    'to_poc': 'Proceed to POC',
    'to_surgery': 'Proceed to Design',
    'poc_retry': 'Retry POC',
    'to_in_dev': 'Proceed to Development',
    'surgery_to_poc': 'Return to POC',
    'to_tda': 'Proceed to Tech Review',
    'dev_retry': 'Continue Development',
    'to_tech_forum': 'Proceed to Tech Forum',
    'tda_to_dev': 'Return to Development',
    'to_uat': 'Proceed to UAT',
    'tech_to_tda': 'Return to TDA',
    'to_prod': 'Deploy to Production',
    'uat_to_tech': 'Return to Tech Forum',
    'to_done': 'Mark as Completed',
    'prod_to_uat': 'Return to UAT',
    'force_done': 'Force Complete Workflow'
}

# 路由定义
@app.route('/')
def index():
    return render_template('index.html')

# Jira登录功能
@app.route('/api/jira/login', methods=['POST'])
def jira_login():
    global jira
    data = request.json
    server = data.get('server')
    email = data.get('email')
    api_token = data.get('api_token')
    
    if not all([server, email, api_token]):
        return jsonify({'status': 'error', 'message': 'Missing login credentials'}), 400
    
    try:
        # 尝试连接Jira
        jira = JIRA(server=server, basic_auth=(email, api_token))
        # 验证连接成功（获取当前用户信息）
        user = jira.myself()
        session['jira_logged_in'] = True
        session['jira_server'] = server
        return jsonify({
            'status': 'success',
            'message': f"Successfully logged in as {user['displayName']}"
        })
    except JIRAError as e:
        return jsonify({'status': 'error', 'message': f"Login failed: {e.text}"}), 401
    except Exception as e:
        return jsonify({'status': 'error', 'message': f"Connection error: {str(e)}"}), 500

# 创建新Issue功能
@app.route('/api/jira/create-issue', methods=['POST'])
def create_jira_issue():
    global jira
    if not jira or not session.get('jira_logged_in'):
        return jsonify({'status': 'error', 'message': 'Please log in to Jira first'}), 401
    
    data = request.json
    project_key = data.get('project_key')
    summary = data.get('summary')
    description = data.get('description', '')
    
    if not all([project_key, summary]):
        return jsonify({'status': 'error', 'message': 'Project key and summary are required'}), 400
    
    try:
        # 创建Architecture Decision类型的issue（假设issue类型名称为"Architecture Decision"）
        issue = jira.create_issue(
            project={'key': project_key},
            summary=summary,
            description=description,
            issuetype={'name': 'Architecture Decision'},
            status={'name': 'OPEN'}  # 初始状态设置为OPEN
        )
        return jsonify({
            'status': 'success',
            'issue_key': issue.key,
            'issue_url': issue.permalink()
        })
    except JIRAError as e:
        return jsonify({'status': 'error', 'message': f"Issue creation failed: {e.text}"}), 400
    except Exception as e:
        return jsonify({'status': 'error', 'message': f"Error: {str(e)}"}), 500

# 获取当前状态
@app.route('/api/state', methods=['GET'])
def get_current_state():
    current_state = workflow.state
    return jsonify({
        'state': current_state,
        'description': state_descriptions.get(current_state, ''),
        'available_transitions': [
            {
                'trigger': t.name,
                'label': transition_labels.get(t.name, t.name)
            } 
            for t in workflow.machine.get_triggers(current_state)
        ]
    })

# 触发状态过渡
@app.route('/api/transition', methods=['POST'])
def trigger_transition():
    data = request.json
    trigger = data.get('trigger')
    
    if not trigger:
        return jsonify({'status': 'error', 'message': 'Missing transition trigger'}), 400
    
    try:
        if hasattr(workflow, trigger):
            getattr(workflow, trigger)()
            return jsonify({
                'status': 'success',
                'new_state': workflow.state,
                'description': state_descriptions.get(workflow.state, '')
            })
        return jsonify({'status': 'error', 'message': 'Invalid transition trigger'}), 400
    except Exception as e:
        return jsonify({'status': 'error', 'message': str(e)}), 500

if __name__ == '__main__':
    app.run(debug=True)
