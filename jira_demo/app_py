from flask import Flask, render_template, request, redirect, url_for, session, jsonify
from jira import JIRA
from jira.exceptions import JIRAError
import os
from datetime import datetime

app = Flask(__name__)
app.secret_key = os.urandom(24)  # 用于会话管理


# 添加上下文处理器，让now变量在所有模板中可用
@app.context_processor
def inject_now():
    return {'now': datetime.utcnow()}


def get_jira_instance():
    """从会话信息创建JIRA实例"""
    if 'jira_auth' not in session or 'jira_url' not in session:
        return None
    username, password = session['jira_auth']
    return JIRA(
        options={'server': session['jira_url']},
        basic_auth=(username, password)
    )


@app.route('/')
def index():
    """首页路由 - 已登录则显示功能页面，否则显示登录页"""
    if 'jira_auth' in session:
        return render_template('dashboard.html')
    return render_template('login.html')


@app.route('/login', methods=['POST'])
def login():
    """处理 Jira 登录请求（使用python-jira库）"""
    username = request.form.get('username')
    password = request.form.get('password')
    jira_url = request.form.get('jira_url')
    
    # 验证输入
    if not all([username, password, jira_url]):
        return render_template('login.html', error="All fields are required")
    
    # 尝试使用python-jira库连接Jira
    try:
        # 配置Jira连接
        jira_options = {
            'server': jira_url.rstrip('/'),
            'verify': True  # 验证SSL证书
        }
        
        # 使用用户名密码登录
        jira = JIRA(options=jira_options, basic_auth=(username, password))
        
        # 登录成功 - 获取用户信息验证连接
        user_info = jira.myself()
        
        # 保存关键信息到会话
        session['jira_auth'] = (username, password)
        session['jira_url'] = jira_url.rstrip('/')
        session['user_info'] = user_info
        
        return redirect(url_for('index'))
    
    except JIRAError as e:
        # 处理Jira相关错误
        if e.status_code == 401:
            return render_template('login.html', error="Invalid username or password")
        elif e.status_code == 403:
            return render_template('login.html', error="Permission denied - check your access")
        elif e.status_code == 404:
            return render_template('login.html', error="Jira URL not found - check the URL")
        else:
            return render_template('login.html', error=f"Jira error: {str(e)}")
    except Exception as e:
        # 处理其他连接错误
        return render_template('login.html', error=f"Connection error: {str(e)}")


@app.route('/logout')
def logout():
    """登出功能 - 清除会话"""
    session.pop('jira_auth', None)
    session.pop('user_info', None)
    session.pop('jira_url', None)
    return redirect(url_for('index'))


@app.route('/create-issue', methods=['GET', 'POST'])
def create_issue():
    """创建 Jira Issue 功能（使用python-jira库）"""
    jira = get_jira_instance()
    if not jira:
        return redirect(url_for('index'))
    
    # 获取项目列表
    projects = []
    try:
        projects = sorted(jira.projects(), key=lambda x: x.name)
    except JIRAError as e:
        return render_template('create_issue.html', projects=[], error=f"Error fetching projects: {str(e)}")
    
    if request.method == 'POST':
        # 处理创建issue请求
        try:
            issue_dict = {
                'project': {'id': request.form.get('project_id')},
                'summary': request.form.get('summary'),
                'description': request.form.get('description'),
                'issuetype': {'name': request.form.get('issue_type')},
            }
            issue = jira.create_issue(fields=issue_dict)
            return redirect(url_for('issue_detail', issue_key=issue.key))
        except JIRAError as e:
            return render_template('create_issue.html', 
                                  projects=projects, 
                                  error=f"Error creating issue: {str(e)}")
    
    return render_template('create_issue.html', projects=projects)


@app.route('/issue/<issue_key>')
def issue_detail(issue_key):
    """显示指定 issue 的详细信息和状态转换选项"""
    jira = get_jira_instance()
    if not jira:
        return redirect(url_for('index'))
    
    try:
        # 获取issue详情（包含转换信息）
        issue = jira.issue(issue_key, expand='transitions')
        return render_template('issue_detail.html', 
                              issue=issue,
                              issue_key=issue_key)
    
    except JIRAError as e:
        return render_template('issue_detail.html', 
                              error=f"Error fetching issue: {str(e)}")
    except Exception as e:
        return render_template('issue_detail.html', 
                              error=f"Connection error: {str(e)}")


@app.route('/transition-issue/<issue_key>', methods=['POST'])
def transition_issue(issue_key):
    """处理 issue 状态转换"""
    jira = get_jira_instance()
    if not jira:
        return jsonify({"status": "error", "message": "Not authenticated"}), 401
    
    transition_id = request.json.get('transition_id')
    if not transition_id:
        return jsonify({"status": "error", "message": "Transition ID required"}), 400
    
    try:
        jira.transition_issue(issue_key, transition_id)
        return jsonify({"status": "success", "message": "Transition successful"})
    
    except JIRAError as e:
        return jsonify({
            "status": "error", 
            "message": f"Transition failed: {str(e)}"
        }), e.status_code
    except Exception as e:
        return jsonify({"status": "error", "message": str(e)}), 500


if __name__ == '__main__':
    app.run(debug=True)
