# app.py
from flask import Flask, render_template, request, redirect, url_for, session, jsonify
import requests
from requests.auth import HTTPBasicAuth
import os
from datetime import datetime

app = Flask(__name__)
app.secret_key = os.urandom(24)  # 用于会话管理

# Jira API 基础配置
JIRA_BASE_URL = ""  # 用户需要填写自己的 Jira 基础 URL

@app.route('/')
def index():
    """首页路由 - 已登录则显示功能页面，否则显示登录页"""
    if 'jira_auth' in session:
        return render_template('dashboard.html')
    return render_template('login.html')

@app.route('/login', methods=['POST'])
def login():
    """处理 Jira 登录请求"""
    username = request.form.get('username')
    api_token = request.form.get('api_token')
    jira_url = request.form.get('jira_url')
    
    # 验证输入
    if not all([username, api_token, jira_url]):
        return render_template('login.html', error="All fields are required")
    
    # 保存 Jira URL 到会话
    global JIRA_BASE_URL
    JIRA_BASE_URL = jira_url.rstrip('/')
    
    # 尝试连接 Jira 验证凭据
    try:
        auth = HTTPBasicAuth(username, api_token)
        headers = {"Accept": "application/json"}
        
        response = requests.get(
            f"{JIRA_BASE_URL}/rest/api/3/myself",
            headers=headers,
            auth=auth
        )
        
        if response.status_code == 200:
            # 登录成功，保存凭据到会话
            session['jira_auth'] = (username, api_token)
            session['user_info'] = response.json()
            return redirect(url_for('index'))
        else:
            return render_template('login.html', error="Invalid credentials or Jira URL")
    
    except Exception as e:
        return render_template('login.html', error=f"Connection error: {str(e)}")

@app.route('/logout')
def logout():
    """登出功能 - 清除会话"""
    session.pop('jira_auth', None)
    session.pop('user_info', None)
    return redirect(url_for('index'))

@app.route('/create-issue', methods=['GET', 'POST'])
def create_issue():
    """创建 Jira Issue 功能"""
    if 'jira_auth' not in session:
        return redirect(url_for('index'))
    
    username, api_token = session['jira_auth']
    auth = HTTPBasicAuth(username, api_token)
    headers = {
        "Accept": "application/json",
        "Content-Type": "application/json"
    }
    
    # 获取项目列表（用于表单下拉选择）
    projects = []
    try:
        response = requests.get(
            f"{JIRA_BASE_URL}/rest/api/3/project",
            headers=headers,
            auth=auth
        )
        if response.status_code == 200:
            projects = sorted(response.json(), key=lambda x: x['name'])
    except Exception as e:
        return render_template('create_issue.html', projects=[], error=f"Error fetching projects: {str(e)}")
    
    if request.method == 'POST':
        # 处理创建 issue 请求
        issue_data = {
            "fields": {
                "project": {
                    "id": request.form.get('project_id')
                },
                "summary": request.form.get('summary'),
                "description": {
                    "type": "doc",
                    "version": 1,
                    "content": [
                        {
                            "type": "paragraph",
                            "content": [
                                {
                                    "type": "text",
                                    "text": request.form.get('description')
                                }
                            ]
                        }
                    ]
                },
                "issuetype": {
                    "name": request.form.get('issue_type')
                }
            }
        }
        
        try:
            response = requests.post(
                f"{JIRA_BASE_URL}/rest/api/3/issue",
                json=issue_data,
                headers=headers,
                auth=auth
            )
            
            if response.status_code == 201:
                issue = response.json()
                return redirect(url_for('issue_detail', issue_key=issue['key']))
            else:
                return render_template('create_issue.html', 
                                      projects=projects, 
                                      error=f"Error creating issue: {response.text}")
        except Exception as e:
            return render_template('create_issue.html', 
                                  projects=projects, 
                                  error=f"Connection error: {str(e)}")
    
    # GET 请求 - 显示创建 issue 表单
    return render_template('create_issue.html', projects=projects)

@app.route('/issue/<issue_key>')
def issue_detail(issue_key):
    """显示指定 issue 的详细信息和状态转换选项"""
    if 'jira_auth' not in session:
        return redirect(url_for('index'))
    
    username, api_token = session['jira_auth']
    auth = HTTPBasicAuth(username, api_token)
    headers = {"Accept": "application/json"}
    
    try:
        # 获取 issue 详情
        issue_response = requests.get(
            f"{JIRA_BASE_URL}/rest/api/3/issue/{issue_key}?expand=transitions",
            headers=headers,
            auth=auth
        )
        
        if issue_response.status_code != 200:
            return render_template('issue_detail.html', 
                                  error=f"Error fetching issue: {issue_response.text}")
        
        issue_data = issue_response.json()
        return render_template('issue_detail.html', 
                              issue=issue_data,
                              issue_key=issue_key)
    
    except Exception as e:
        return render_template('issue_detail.html', 
                              error=f"Connection error: {str(e)}")

@app.route('/transition-issue/<issue_key>', methods=['POST'])
def transition_issue(issue_key):
    """处理 issue 状态转换"""
    if 'jira_auth' not in session:
        return jsonify({"status": "error", "message": "Not authenticated"}), 401
    
    transition_id = request.json.get('transition_id')
    if not transition_id:
        return jsonify({"status": "error", "message": "Transition ID required"}), 400
    
    username, api_token = session['jira_auth']
    auth = HTTPBasicAuth(username, api_token)
    headers = {
        "Accept": "application/json",
        "Content-Type": "application/json"
    }
    
    try:
        response = requests.post(
            f"{JIRA_BASE_URL}/rest/api/3/issue/{issue_key}/transitions",
            json={"transition": {"id": transition_id}},
            headers=headers,
            auth=auth
        )
        
        if response.status_code in [200, 204]:
            return jsonify({"status": "success", "message": "Transition successful"})
        else:
            return jsonify({
                "status": "error", 
                "message": f"Transition failed: {response.text}"
            }), response.status_code
    
    except Exception as e:
        return jsonify({"status": "error", "message": str(e)}), 500

if __name__ == '__main__':
    app.run(debug=True)
