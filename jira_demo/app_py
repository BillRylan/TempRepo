from flask import Flask, render_template, jsonify, request, session
from jira import JIRA
from jira.exceptions import JIRAError
import os
from datetime import datetime

app = Flask(__name__)
app.secret_key = os.urandom(24)  # 会话管理密钥

# 全局变量
jira = None  # Jira连接实例
selected_issue_key = None  # 当前选中的Issue Key

# 状态描述映射（用于UI展示）
STATE_DESCRIPTIONS = {
    'OPEN': 'Initial state: Architecture decision proposal created',
    'POC': 'Proof of Concept: Validating technical feasibility',
    'SURGERY': 'Solution Design: Developing detailed implementation plan',
    'IN_DEV': 'In Development: Implementation according to plan',
    'TDA': 'Technical Decision Review: Internal technical assessment',
    'TECH_FORUM': 'Technical Forum Review: Cross-team technical evaluation',
    'UAT': 'User Acceptance Testing: Verifying requirements fulfillment',
    'PROD': 'Production Deployment: Live in production environment',
    'DONE': 'Completed: Workflow finalized'
}

# 路由定义
@app.route('/')
def index():
    """渲染主页面"""
    return render_template('index.html')

@app.route('/api/jira/login', methods=['POST'])
def jira_login():
    """Jira登录接口"""
    global jira
    data = request.json
    server = data.get('server')
    email = data.get('email')
    api_token = data.get('api_token')
    
    if not all([server, email, api_token]):
        return jsonify({'status': 'error', 'message': 'Missing login credentials'}), 400
    
    try:
        # 建立Jira连接
        jira = JIRA(server=server, basic_auth=(email, api_token))
        user = jira.myself()
        session['jira_logged_in'] = True
        session['jira_user'] = user['displayName']
        return jsonify({
            'status': 'success',
            'message': f"Successfully logged in as {user['displayName']}",
            'user': user['displayName']
        })
    except JIRAError as e:
        return jsonify({'status': 'error', 'message': f"Login failed: {e.text}"}), 401
    except Exception as e:
        return jsonify({'status': 'error', 'message': f"Connection error: {str(e)}"}), 500

@app.route('/api/jira/create-issue', methods=['POST'])
def create_jira_issue():
    """创建Jira Issue接口"""
    global jira, selected_issue_key
    if not jira or not session.get('jira_logged_in'):
        return jsonify({'status': 'error', 'message': 'Please log in to Jira first'}), 401
    
    data = request.json
    project_key = data.get('project_key')
    summary = data.get('summary')
    description = data.get('description', '')
    
    if not all([project_key, summary]):
        return jsonify({'status': 'error', 'message': 'Project key and summary are required'}), 400
    
    try:
        # 创建Issue（确保Issue类型在Jira中存在）
        issue = jira.create_issue(
            project={'key': project_key},
            summary=summary,
            description=description,
            issuetype={'name': 'Architecture Decision'}  # 需与Jira中的Issue类型匹配
        )
        selected_issue_key = issue.key
        return jsonify({
            'status': 'success',
            'issue_key': issue.key,
            'issue_url': issue.permalink(),
            'message': f"Issue {issue.key} created successfully"
        })
    except JIRAError as e:
        return jsonify({'status': 'error', 'message': f"Issue creation failed: {e.text}"}), 400
    except Exception as e:
        return jsonify({'status': 'error', 'message': f"Error: {str(e)}"}), 500

@app.route('/api/jira/select-issue', methods=['POST'])
def select_issue():
    """选择已有Jira Issue接口"""
    global jira, selected_issue_key
    if not jira or not session.get('jira_logged_in'):
        return jsonify({'status': 'error', 'message': 'Please log in to Jira first'}), 401
    
    data = request.json
    issue_key = data.get('issue_key')
    
    if not issue_key:
        return jsonify({'status': 'error', 'message': 'Issue key is required'}), 400
    
    try:
        # 验证Issue存在
        issue = jira.issue(issue_key)
        selected_issue_key = issue_key
        return jsonify({
            'status': 'success',
            'issue_key': issue_key,
            'issue_summary': issue.fields.summary,
            'message': f"Issue {issue_key} selected successfully"
        })
    except JIRAError as e:
        return jsonify({'status': 'error', 'message': f"Issue not found: {e.text}"}), 404
    except Exception as e:
        return jsonify({'status': 'error', 'message': f"Error: {str(e)}"}), 500

@app.route('/api/jira/issue-details', methods=['GET'])
def get_issue_details():
    """获取当前选中Issue的详细信息（状态及可用过渡）"""
    global jira, selected_issue_key
    if not jira or not session.get('jira_logged_in') or not selected_issue_key:
        return jsonify({'status': 'error', 'message': 'Please log in and select an issue first'}), 401
    
    try:
        # 获取Issue详情
        issue = jira.issue(selected_issue_key)
        current_status = issue.fields.status.name
        current_assignee = issue.fields.assignee.displayName if issue.fields.assignee else 'Unassigned'
        created_date = datetime.strptime(issue.fields.created, '%Y-%m-%dT%H:%M:%S.%f%z').strftime('%Y-%m-%d %H:%M:%S')
        
        # 获取可用状态过渡
        transitions = jira.transitions(issue)
        available_transitions = [
            {
                'id': t['id'],
                'name': t['name'],
                'to_state': t['to']['name']
            } for t in transitions
        ]
        
        return jsonify({
            'status': 'success',
            'issue_key': selected_issue_key,
            'summary': issue.fields.summary,
            'description': issue.fields.description or 'No description provided',
            'current_state': {
                'name': current_status,
                'description': STATE_DESCRIPTIONS.get(current_status, f"State: {current_status}")
            },
            'assignee': current_assignee,
            'created_date': created_date,
            'available_transitions': available_transitions
        })
    except JIRAError as e:
        return jsonify({'status': 'error', 'message': f"Failed to get issue details: {e.text}"}), 400
    except Exception as e:
        return jsonify({'status': 'error', 'message': f"Error: {str(e)}"}), 500

@app.route('/api/jira/transition-issue', methods=['POST'])
def transition_issue():
    """触发Issue状态流转接口"""
    global jira, selected_issue_key
    if not jira or not session.get('jira_logged_in') or not selected_issue_key:
        return jsonify({'status': 'error', 'message': 'Please log in and select an issue first'}), 401
    
    data = request.json
    transition_id = data.get('transition_id')
    
    if not transition_id:
        return jsonify({'status': 'error', 'message': 'Transition ID is required'}), 400
    
    try:
        # 执行状态流转
        issue = jira.issue(selected_issue_key)
        previous_state = issue.fields.status.name
        jira.transition_issue(issue, transition_id)
        
        # 获取流转后的状态
        updated_issue = jira.issue(selected_issue_key)
        new_state = updated_issue.fields.status.name
        
        return jsonify({
            'status': 'success',
            'previous_state': previous_state,
            'new_state': new_state,
            'message': f"Issue status updated from {previous_state} to {new_state}"
        })
    except JIRAError as e:
        return jsonify({'status': 'error', 'message': f"Transition failed: {e.text}"}), 400
    except Exception as e:
        return jsonify({'status': 'error', 'message': f"Error: {str(e)}"}), 500

if __name__ == '__main__':
    app.run(debug=True)
